<!-- Container principal -->
<div class="quiz-container">
  <!-- Loading -->
  <div *ngIf="carregando" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">Carregando quiz...</p>
  </div>

  <!-- Erro -->
  <div *ngIf="erro && !carregando" class="error-container">
    <div class="error-icon">⚠️</div>
    <h2 class="error-title">Ops! Algo deu errado</h2>
    <p class="error-message">{{ erro }}</p>
    <button class="btn btn-primary" (click)="voltarAoCurso()">
      <span class="btn-icon">←</span>
      Voltar ao Curso
    </button>
  </div>

  <!-- Conteúdo do quiz -->
  <div *ngIf="quiz && !carregando" class="quiz-content">
    
    <!-- Estado inicial -->
    <div *ngIf="estadoQuiz === 'inicial'" class="quiz-intro">
      <div class="intro-header">
        <div class="quiz-category">
          <span class="categoria-icon" [style.background-color]="obterCorCategoria(quiz.categoria)">
            {{ obterIconeCategoria(quiz.categoria) }}
          </span>
          <span class="categoria-nome">{{ quiz.categoria | titlecase }}</span>
        </div>
        
        <h1 class="quiz-title">{{ quiz.titulo }}</h1>
        <p class="quiz-description">{{ quiz.descricao }}</p>
      </div>

      <div class="quiz-info">
        <div class="info-grid">
          <div class="info-item">
            <div class="info-icon">❓</div>
            <div class="info-content">
              <span class="info-label">Perguntas</span>
              <span class="info-value">{{ quiz.perguntas.length }}</span>
            </div>
          </div>

          <div class="info-item">
            <div class="info-icon">⏱️</div>
            <div class="info-content">
              <span class="info-label">Tempo Limite</span>
              <span class="info-value">
                {{ quiz.configuracoes.tempoLimite ? quiz.configuracoes.tempoLimite + ' min' : 'Ilimitado' }}
              </span>
            </div>
          </div>

          <div class="info-item">
            <div class="info-icon">🎯</div>
            <div class="info-content">
              <span class="info-label">Nota Mínima</span>
              <span class="info-value">{{ quiz.configuracoes.notaMinima }}%</span>
            </div>
          </div>

          <div class="info-item">
            <div class="info-icon">🔄</div>
            <div class="info-content">
              <span class="info-label">Tentativas</span>
              <span class="info-value">
                {{ quiz.configuracoes.tentativasPermitidas === -1 ? 'Ilimitadas' : quiz.configuracoes.tentativasPermitidas }}
              </span>
            </div>
          </div>
        </div>

        <div class="quiz-instructions">
          <h3 class="instructions-title">📋 Instruções</h3>
          <ul class="instructions-list">
            <li>Leia cada pergunta com atenção antes de responder</li>
            <li>Selecione apenas uma alternativa por pergunta</li>
            <li *ngIf="quiz.configuracoes.tempoLimite">Você tem {{ quiz.configuracoes.tempoLimite }} minutos para completar o quiz</li>
            <li *ngIf="quiz.configuracoes.permitirVoltarPergunta">Você pode voltar e alterar suas respostas</li>
            <li *ngIf="!quiz.configuracoes.permitirVoltarPergunta">Não é possível voltar após responder uma pergunta</li>
            <li>Clique em "Finalizar" quando terminar todas as perguntas</li>
          </ul>
        </div>

        <div class="start-actions">
          <button class="btn btn-primary btn-large" (click)="iniciarQuiz()">
            <span class="btn-icon">🚀</span>
            Iniciar Quiz
          </button>
          <button class="btn btn-outline" (click)="voltarAoCurso()">
            <span class="btn-icon">←</span>
            Voltar ao Curso
          </button>
        </div>
      </div>
    </div>

    <!-- Quiz em andamento -->
    <div *ngIf="estadoQuiz === 'em-andamento'" class="quiz-active">
      <!-- Cabeçalho do quiz ativo -->
      <div class="quiz-header">
        <div class="header-info">
          <h2 class="quiz-title-small">{{ quiz.titulo }}</h2>
          <div class="question-counter">
            Pergunta {{ perguntaAtualIndex + 1 }} de {{ quiz.perguntas.length }}
          </div>
        </div>

        <div class="header-controls">
          <!-- Timer -->
          <div *ngIf="mostrarTimer && quiz.configuracoes.tempoLimite" class="timer">
            <span class="timer-icon">⏰</span>
            <span class="timer-value" [class.timer-warning]="tempoRestante < 300">
              {{ formatarTempo(tempoRestante) }}
            </span>
          </div>

          <!-- Progresso -->
          <div *ngIf="mostrarProgresso" class="progress-info">
            <span class="progress-text">{{ calcularProgresso() }}%</span>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="calcularProgresso()"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Navegação de perguntas -->
      <div class="question-navigation">
        <div class="nav-dots">
          <button *ngFor="let pergunta of quiz.perguntas; let i = index"
                  class="nav-dot"
                  [class.current]="i === perguntaAtualIndex"
                  [class.answered]="obterStatusPergunta(i) === 'respondida'"
                  [class.unanswered]="obterStatusPergunta(i) === 'nao-respondida'"
                  (click)="irParaPergunta(i)"
                  [title]="'Pergunta ' + (i + 1)">
            {{ i + 1 }}
          </button>
        </div>
      </div>

      <!-- Pergunta atual -->
      <div *ngIf="perguntaAtual" class="question-container">
        <div class="question-card">
          <div class="question-header">
            <h3 class="question-title">{{ perguntaAtual.pergunta }}</h3>
            <div *ngIf="perguntaAtual.pontos" class="question-points">
              {{ perguntaAtual.pontos }} {{ perguntaAtual.pontos === 1 ? 'ponto' : 'pontos' }}
            </div>
          </div>

          <!-- Código de exemplo (se houver) -->
          <div *ngIf="perguntaAtual.codigoExemplo" class="code-example">
            <div class="code-header">
              <span class="code-icon">💻</span>
              <span class="code-label">Código de Exemplo</span>
            </div>
            <pre class="code-block"><code>{{ perguntaAtual.codigoExemplo.codigo }}</code></pre>
            <div *ngIf="perguntaAtual.codigoExemplo.linguagem" class="code-language">
              {{ perguntaAtual.codigoExemplo.linguagem }}
            </div>
          </div>

          <!-- Alternativas -->
          <div class="alternatives-container">
            <div *ngFor="let alternativa of perguntaAtual.alternativas" 
                 class="alternative-option"
                 [class.selected]="respostaSelecionada === alternativa.id"
                 (click)="selecionarResposta(alternativa.id)">
              
              <div class="option-radio">
                <input type="radio" 
                       [id]="'alt-' + alternativa.id"
                       [name]="'pergunta-' + perguntaAtual.id"
                       [value]="alternativa.id"
                       [checked]="respostaSelecionada === alternativa.id"
                       (change)="selecionarResposta(alternativa.id)">
                <label [for]="'alt-' + alternativa.id" class="radio-label"></label>
              </div>

              <div class="option-content">
                <span class="option-letter">{{ alternativa.letra }}</span>
                <span class="option-text">{{ alternativa.texto }}</span>
              </div>
            </div>
          </div>

          <!-- Navegação da pergunta -->
          <div class="question-navigation-controls">
            <button class="btn btn-outline" 
                    (click)="perguntaAnterior()"
                    [disabled]="!podeVoltar()">
              <span class="btn-icon">←</span>
              Anterior
            </button>

            <div class="nav-info">
              <span class="response-status" *ngIf="respostaSelecionada">
                ✅ Resposta selecionada
              </span>
              <span class="response-status warning" *ngIf="!respostaSelecionada">
                ⚠️ Selecione uma resposta
              </span>
            </div>

            <button class="btn btn-primary" 
                    (click)="proximaPergunta()"
                    [disabled]="!podeAvancar()">
              <span class="btn-icon">{{ ehUltimaPergunta() ? '🏁' : '→' }}</span>
              {{ ehUltimaPergunta() ? 'Finalizar' : 'Próxima' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Ações do quiz -->
      <div class="quiz-actions">
        <button class="btn btn-outline btn-small" (click)="voltarAoCurso()">
          <span class="btn-icon">←</span>
          Sair do Quiz
        </button>

        <button class="btn btn-warning btn-small" (click)="finalizarQuiz()">
          <span class="btn-icon">🏁</span>
          Finalizar Agora
        </button>
      </div>
    </div>

    <!-- Resultados -->
    <div *ngIf="estadoQuiz === 'finalizado' && mostrarResultados" class="quiz-results">
      <div class="results-header">
        <div class="result-icon" [style.color]="obterCorNota(resultado?.nota || 0)">
          {{ obterIconeResultado(resultado?.nota || 0) }}
        </div>
        <h2 class="results-title">Quiz Finalizado!</h2>
        <p class="results-message">{{ obterMensagemResultado(resultado?.nota || 0) }}</p>
      </div>

      <div class="results-stats">
        <div class="stat-card main-stat">
          <div class="stat-value" [style.color]="obterCorNota(resultado?.nota || 0)">
            {{ resultado?.nota || 0 }}%
          </div>
          <div class="stat-label">Sua Nota</div>
        </div>

        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">{{ resultado?.acertos || 0 }}</div>
            <div class="stat-label">Acertos</div>
          </div>

          <div class="stat-card">
            <div class="stat-value">{{ resultado?.erros || 0 }}</div>
            <div class="stat-label">Erros</div>
          </div>

          <div class="stat-card">
            <div class="stat-value">{{ formatarTempo(resultado?.tempoGasto || 0) }}</div>
            <div class="stat-label">Tempo Gasto</div>
          </div>

          <div class="stat-card">
            <div class="stat-value">{{ quiz.perguntas.length }}</div>
            <div class="stat-label">Total de Perguntas</div>
          </div>
        </div>
      </div>

      <!-- Status de aprovação -->
      <div class="approval-status">
        <div *ngIf="(resultado?.nota || 0) >= quiz.configuracoes.notaMinima" 
             class="status-card approved">
          <div class="status-icon">✅</div>
          <div class="status-content">
            <h3 class="status-title">Parabéns! Você foi aprovado!</h3>
            <p class="status-description">
              Você atingiu a nota mínima de {{ quiz.configuracoes.notaMinima }}% necessária para aprovação.
            </p>
          </div>
        </div>

        <div *ngIf="(resultado?.nota || 0) < quiz.configuracoes.notaMinima" 
             class="status-card failed">
          <div class="status-icon">❌</div>
          <div class="status-content">
            <h3 class="status-title">Você não atingiu a nota mínima</h3>
            <p class="status-description">
              É necessário {{ quiz.configuracoes.notaMinima }}% para aprovação. Continue estudando e tente novamente!
            </p>
          </div>
        </div>
      </div>

      <!-- Ações dos resultados -->
      <div class="results-actions">
        <button class="btn btn-outline" (click)="toggleRevisao()">
          <span class="btn-icon">{{ mostrarRevisao ? '👁️‍🗨️' : '👁️' }}</span>
          {{ mostrarRevisao ? 'Ocultar' : 'Revisar' }} Respostas
        </button>

        <button class="btn btn-secondary" (click)="reiniciarQuiz()">
          <span class="btn-icon">🔄</span>
          Tentar Novamente
        </button>

        <button class="btn btn-primary" (click)="voltarAoCurso()">
          <span class="btn-icon">📚</span>
          Continuar Curso
        </button>
      </div>

      <!-- Revisão das respostas -->
      <div *ngIf="mostrarRevisao" class="review-section">
        <h3 class="review-title">
          <span class="title-icon">🔍</span>
          Revisão das Respostas
        </h3>

        <div class="review-questions">
          <div *ngFor="let pergunta of quiz.perguntas; let i = index" class="review-question">
            <div class="review-header">
              <span class="question-number">{{ i + 1 }}</span>
              <h4 class="review-question-title">{{ pergunta.pergunta }}</h4>
              <div class="question-result">
                <span *ngIf="estaRespostaCorreta(pergunta.id, obterRespostaUsuario(pergunta.id) || '')" 
                      class="result-icon correct">✅</span>
                <span *ngIf="!estaRespostaCorreta(pergunta.id, obterRespostaUsuario(pergunta.id) || '')" 
                      class="result-icon incorrect">❌</span>
              </div>
            </div>

            <div class="review-alternatives">
              <div *ngFor="let alternativa of pergunta.alternativas" 
                   class="review-alternative"
                   [class.user-answer]="obterRespostaUsuario(pergunta.id) === alternativa.id"
                   [class.correct-answer]="pergunta.respostaCorreta === alternativa.id"
                   [class.wrong-answer]="obterRespostaUsuario(pergunta.id) === alternativa.id && pergunta.respostaCorreta !== alternativa.id">
                
                <span class="alt-letter">{{ alternativa.letra }}</span>
                <span class="alt-text">{{ alternativa.texto }}</span>
                
                <div class="alt-indicators">
                  <span *ngIf="obterRespostaUsuario(pergunta.id) === alternativa.id" class="indicator user">Sua resposta</span>
                  <span *ngIf="pergunta.respostaCorreta === alternativa.id" class="indicator correct">Resposta correta</span>
                </div>
              </div>
            </div>

            <div *ngIf="pergunta.explicacao" class="question-explanation">
              <div class="explanation-header">
                <span class="explanation-icon">💡</span>
                <span class="explanation-label">Explicação</span>
              </div>
              <p class="explanation-text">{{ pergunta.explicacao }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>